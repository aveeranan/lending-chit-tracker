{% extends "base.html" %}

{% block title %}Loans - Lending Tracker{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Loans</h1>
    <div class="header-actions">
        <button class="btn btn-secondary" onclick="exportLoans()">Export CSV</button>
        <button class="btn btn-primary" onclick="showAddLoanModal()">+ Add Loan</button>
    </div>
</div>

<!-- Summary Banner -->
<div class="loans-summary-banner" id="loansSummaryBanner">
    <div class="summary-header">
        <h3 style="margin: 0; color: white;">Loans Summary</h3>
        <button class="btn btn-sm" onclick="toggleLoanAmounts()" id="toggleLoanAmountsBtn" style="padding: 0.3rem 0.8rem; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white;">
            <span id="toggleLoanIcon">üëÅÔ∏è</span> <span id="toggleLoanText">Hide Amounts</span>
        </button>
    </div>
    <div class="summary-items">
        <div class="summary-item">
            <div class="summary-label">Total Loans</div>
            <div class="summary-value" id="summaryTotalLoans">-</div>
        </div>
        <div class="summary-item">
            <div class="summary-label">Total Principal Given</div>
            <div class="summary-value" id="summaryPrincipalGiven">-</div>
        </div>
        <div class="summary-item">
            <div class="summary-label">Total Outstanding</div>
            <div class="summary-value" id="summaryOutstanding">-</div>
        </div>
        <div class="summary-item">
            <div class="summary-label">Total Pending Interest</div>
            <div class="summary-value" id="summaryPendingInterest">-</div>
        </div>
    </div>
</div>

<div class="filters">
    <div class="filter-group">
        <label>Status:</label>
        <select id="statusFilter" onchange="loadLoans()">
            <option value="">All</option>
            <option value="Active" selected>Active</option>
            <option value="Closed">Closed</option>
        </select>
    </div>
    <div class="filter-group">
        <label>Search:</label>
        <input type="text" id="searchFilter" placeholder="Borrower name or phone" onkeyup="loadLoans()">
    </div>
</div>

<div class="table-container">
    <table class="data-table" id="loansTable">
        <thead>
            <tr>
                <th>Borrower</th>
                <th>Phone</th>
                <th>Principal Given</th>
                <th>Outstanding Principal</th>
                <th>Monthly Rate</th>
                <th>Interest Due (Month)</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="loansTableBody">
            <tr>
                <td colspan="8" class="loading">Loading loans...</td>
            </tr>
        </tbody>
    </table>
</div>

<!-- Add Loan Modal -->
<div id="addLoanModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add New Loan</h2>
            <span class="close" onclick="closeAddLoanModal()">&times;</span>
        </div>
        <form id="addLoanForm" onsubmit="submitLoan(event)">
            <div class="form-group">
                <label for="borrower_name">Borrower Name *</label>
                <input type="text" id="borrower_name" name="borrower_name" required>
            </div>
            <div class="form-group">
                <label for="phone">Phone</label>
                <input type="text" id="phone" name="phone">
            </div>
            <div class="form-group">
                <label for="principal_given">Principal Given *</label>
                <input type="number" id="principal_given" name="principal_given" step="0.01" required>
            </div>
            <div class="form-group">
                <label for="given_date">Given Date *</label>
                <input type="date" id="given_date" name="given_date" required>
            </div>
            <div class="form-group">
                <label for="monthly_rate">Interest Rate (Monthly %) *</label>
                <input type="number" id="monthly_rate" name="monthly_rate" step="0.01" required>
            </div>
            <div class="form-group">
                <label for="interest_due_day">Interest Due Day (1-28)</label>
                <input type="number" id="interest_due_day" name="interest_due_day" min="1" max="28" value="5">
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="document_received" name="document_received">
                    Document Received
                </label>
            </div>
            <div id="documentFields" style="display: none;">
                <div class="form-group">
                    <label for="document_type">Document Type</label>
                    <input type="text" id="document_type" name="document_type">
                </div>
                <div class="form-group">
                    <label for="document_path">Document Path</label>
                    <input type="text" id="document_path" name="document_path">
                </div>
                <div class="form-group">
                    <label for="document_received_date">Document Received Date</label>
                    <input type="date" id="document_received_date" name="document_received_date">
                </div>
            </div>
            <div class="form-group">
                <label for="notes">Notes</label>
                <textarea id="notes" name="notes" rows="3"></textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeAddLoanModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Loan</button>
            </div>
        </form>
    </div>
</div>

<!-- Close Loan Modal -->
<div id="closeLoanModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Close Loan</h2>
            <span class="close" onclick="closeCloseLoanModal()">&times;</span>
        </div>
        <div id="closeLoanInfo"></div>
        <form id="closeLoanForm" onsubmit="submitCloseLoan(event)">
            <div class="form-group">
                <label for="close_reason">Close Reason</label>
                <select id="close_reason" name="close_reason">
                    <option value="fully_repaid">Fully Repaid</option>
                    <option value="settled">Settled</option>
                    <option value="written_off">Written Off</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="warning-message">
                This loan will be closed even if there are pending amounts.
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeCloseLoanModal()">Cancel</button>
                <button type="submit" class="btn btn-danger">Close Loan</button>
            </div>
        </form>
    </div>
</div>

<!-- View Loan Modal -->
<div id="viewLoanModal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h2>Loan Details</h2>
            <span class="close" onclick="closeViewLoanModal()">&times;</span>
        </div>
        <div id="viewLoanContent"></div>
    </div>
</div>

<!-- Edit Loan Modal -->
<div id="editLoanModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Edit Loan</h2>
            <span class="close" onclick="closeEditLoanModal()">&times;</span>
        </div>
        <form id="editLoanForm" onsubmit="submitEditLoan(event)">
            <input type="hidden" id="edit_loan_id" name="edit_loan_id">
            <div class="form-group">
                <label for="edit_borrower_name">Borrower Name *</label>
                <input type="text" id="edit_borrower_name" name="edit_borrower_name" required>
            </div>
            <div class="form-group">
                <label for="edit_phone">Phone</label>
                <input type="text" id="edit_phone" name="edit_phone">
            </div>
            <div class="form-group">
                <label for="edit_principal_given">Principal Given *</label>
                <input type="number" id="edit_principal_given" name="edit_principal_given" step="0.01" required>
                <small style="color: #7f8c8d;">Warning: Changing this affects interest calculations</small>
            </div>
            <div class="form-group">
                <label for="edit_outstanding_principal">Outstanding Principal *</label>
                <input type="number" id="edit_outstanding_principal" name="edit_outstanding_principal" step="0.01" required>
                <small style="color: #7f8c8d;">This should match: Principal Given - Total Principal Paid</small>
            </div>
            <div class="form-group">
                <label for="edit_given_date">Given Date *</label>
                <input type="date" id="edit_given_date" name="edit_given_date" required>
            </div>
            <div class="form-group">
                <label for="edit_monthly_rate">Interest Rate (Monthly %) *</label>
                <input type="number" id="edit_monthly_rate" name="edit_monthly_rate" step="0.01" required>
                <small style="color: #7f8c8d;">Warning: Changing this affects future interest calculations</small>
            </div>
            <div class="form-group">
                <label for="edit_interest_due_day">Interest Due Day (1-28)</label>
                <input type="number" id="edit_interest_due_day" name="edit_interest_due_day" min="1" max="28" value="5">
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="edit_document_received" name="edit_document_received">
                    Document Received
                </label>
            </div>
            <div id="editDocumentFields" style="display: none;">
                <div class="form-group">
                    <label for="edit_document_type">Document Type</label>
                    <input type="text" id="edit_document_type" name="edit_document_type">
                </div>
                <div class="form-group">
                    <label for="edit_document_path">Document Path</label>
                    <input type="text" id="edit_document_path" name="edit_document_path">
                </div>
                <div class="form-group">
                    <label for="edit_document_received_date">Document Received Date</label>
                    <input type="date" id="edit_document_received_date" name="edit_document_received_date">
                </div>
            </div>
            <div class="form-group">
                <label for="edit_notes">Notes</label>
                <textarea id="edit_notes" name="edit_notes" rows="3"></textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeEditLoanModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Update Loan</button>
            </div>
        </form>
    </div>
</div>

<script src="{{ url_for('static', filename='js/loans.js') }}"></script>
{% endblock %}
